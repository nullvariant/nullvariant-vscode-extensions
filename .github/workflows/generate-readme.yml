name: Check README Sync

on:
  pull_request:
    paths:
      - 'extensions/git-id-switcher/docs/i18n/en/README.md'
      - 'extensions/git-id-switcher/README.md'
  workflow_dispatch:  # Manual trigger for verification

permissions: {}

# README auto-generation is handled by local pre-commit hook (husky)
# This workflow only verifies sync as a safety net

jobs:
  check-sync:
    name: Verify README is in sync
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: extensions/git-id-switcher/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: extensions/git-id-switcher

      - name: Generate README (dry-run)
        working-directory: extensions/git-id-switcher
        run: npm run generate:readme

      - name: Verify sync
        working-directory: extensions/git-id-switcher
        run: |
          if git diff --quiet README.md; then
            echo "âœ… README.md is in sync with docs/i18n/en/README.md"
          else
            echo "::error::README.md is out of sync with docs/i18n/en/README.md"
            echo ""
            echo "The pre-commit hook should have handled this automatically."
            echo "If you bypassed the hook, please run:"
            echo ""
            echo "  cd extensions/git-id-switcher"
            echo "  npm run generate:readme"
            echo "  git add README.md"
            echo "  git commit --amend --no-edit"
            echo ""
            echo "Diff:"
            git diff README.md
            exit 1
          fi
