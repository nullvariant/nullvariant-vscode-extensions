# nullvariant-mimi[bot] - The keen listener
# "ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼ã‚’é€šã—ã¦ãã ã•ã„ã­"

name: ğŸ° Mimi Bot

permissions: {}

on:
  workflow_dispatch:
    inputs:
      message:
        description: 'What did Mimi hear? (optional)'
        required: false
        default: 'I heard something...'

jobs:
  mimi-commit:
    name: ğŸ° Listen carefully
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: ğŸ° Perk up ears
        run: |
          echo "ğŸ° *ears twitching*"
          echo "Shh... I'm listening..."
          echo "Did someone forget to validate their input?"

      - name: ğŸ”‘ Get App Token
        id: app-token
        uses: tibdex/github-app-token@3beb63f4bd073e61482598c45c71c1019b59b73a # v2
        with:
          app_id: ${{ secrets.MIMI_BOT_APP_ID }}
          private_key: ${{ secrets.MIMI_BOT_PRIVATE_KEY }}

      - name: ğŸ“¥ Checkout (quietly)
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          token: ${{ steps.app-token.outputs.token }}

      # SECURITY: Use environment variable to prevent script injection
      # See: https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions#understanding-the-risk-of-script-injection
      - name: ğŸ“ Leave a whispered note
        env:
          USER_MESSAGE: ${{ github.event.inputs.message }}
        run: |
          mkdir -p docs
          cat > docs/MIMI.md << 'EOF'
          # ğŸ° Mimi's Listening Post

          > "These ears don't miss a thing."

          ## Today's Whisper

          EOF
          printf '%s\n' "${USER_MESSAGE}" >> docs/MIMI.md
          cat >> docs/MIMI.md << 'EOF'

          ### Reminder
          Always validate your inputs!
          Mimi's ears can hear unvalidated data from miles away...

          ---

          EOF
          echo "*Last heard: $(date -u +"%Y-%m-%d %H:%M:%S UTC")*" >> docs/MIMI.md
          cat >> docs/MIMI.md << 'EOF'

          > ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼ã‚’é€šã—ã¦ãã ã•ã„ã­
          EOF

      - name: ğŸ“¬ Create PR with verified commit
        env:
          USER_MESSAGE: ${{ github.event.inputs.message }}
        uses: peter-evans/create-pull-request@22a9089034f40e5a961c8808d113e2c98fb63676 # v7
        with:
          token: ${{ steps.app-token.outputs.token }}
          sign-commits: true
          author: nullvariant-mimi[bot] <2610795+nullvariant-mimi[bot]@users.noreply.github.com>
          committer: nullvariant-mimi[bot] <2610795+nullvariant-mimi[bot]@users.noreply.github.com>
          commit-message: |
            ğŸ° Heard something important

            ${{ env.USER_MESSAGE }}

            *ears still listening*
          branch: mimi/whisper-${{ github.run_number }}
          delete-branch: true
          title: "ğŸ° Mimi's listening post update"
          body: |
            ## ğŸ° *whispers*

            ${{ env.USER_MESSAGE }}

            ---

            > ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼ã‚’é€šã—ã¦ãã ã•ã„ã­

            *This PR was quietly delivered by nullvariant-mimi[bot]*

      - name: ğŸ‘‚ Keep listening
        run: |
          echo "*ears still perked*"
          echo "Always listening for unvalidated inputs..."
          echo "ğŸ° Stay safe out there!"
