name: Deploy Documentation

on:
  push:
    branches:
      - main
    paths:
      - 'README.md'                               # Monorepo root
      - 'CONTRIBUTING.md'                         # Monorepo root
      - 'LICENSE'                                 # Monorepo root
      - 'extensions/git-id-switcher/**/*.md'      # All .md files (auto-detected)
      - 'extensions/git-id-switcher/LICENSE'      # Extension LICENSE
  workflow_dispatch:  # Manual trigger

permissions: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for hash update commits
    # Prevent forks from deploying (no Cloudflare secrets)
    if: github.repository == 'nullvariant/nullvariant-vscode-extensions'

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: '20'

      - name: Install dependencies for hash script
        working-directory: extensions/git-id-switcher
        run: npm ci

      - name: Update document hashes
        working-directory: extensions/git-id-switcher
        run: node scripts/update-doc-hashes.mjs

      - name: Commit hash updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add extensions/git-id-switcher/src/documentation.internal.ts
          if git diff --staged --quiet; then
            echo "No hash changes"
          else
            git commit -m "chore: auto-update document hashes"
            git push
          fi

      - name: Deploy documentation to R2
        run: |
          R2_BASE="nullvariant-assets/nullvariant-vscode-extensions"
          EXT_PATH="extensions/git-id-switcher"

          # === Monorepo root files ===
          echo "=== Deploying monorepo root files ==="

          if [ -f "README.md" ]; then
            echo "Deploying monorepo README.md..."
            npx wrangler@4.54.0 r2 object put "${R2_BASE}/README.md" \
              --file "README.md" \
              --content-type "text/markdown; charset=utf-8" \
              --remote
          fi

          if [ -f "CONTRIBUTING.md" ]; then
            echo "Deploying monorepo CONTRIBUTING.md..."
            npx wrangler@4.54.0 r2 object put "${R2_BASE}/CONTRIBUTING.md" \
              --file "CONTRIBUTING.md" \
              --content-type "text/markdown; charset=utf-8" \
              --remote
          fi

          if [ -f "LICENSE" ]; then
            echo "Deploying monorepo LICENSE..."
            npx wrangler@4.54.0 r2 object put "${R2_BASE}/LICENSE" \
              --file "LICENSE" \
              --content-type "text/plain; charset=utf-8" \
              --remote
          fi

          # === Extension files (all .md + LICENSE) ===
          echo "=== Deploying all extension .md files ==="

          # Deploy all .md files in extension directory (recursive)
          find "${EXT_PATH}" -name "*.md" -type f \
            ! -path "${EXT_PATH}/node_modules/*" \
            ! -path "${EXT_PATH}/out/*" \
            ! -path "${EXT_PATH}/.vscode-test/*" | while read -r doc_file; do
            relative_path="${doc_file#${EXT_PATH}/}"
            echo "Deploying ${relative_path}..."
            npx wrangler@4.54.0 r2 object put "${R2_BASE}/${EXT_PATH}/${relative_path}" \
              --file "$doc_file" \
              --content-type "text/markdown; charset=utf-8" \
              --remote
          done

          # Deploy extension LICENSE
          if [ -f "${EXT_PATH}/LICENSE" ]; then
            echo "Deploying extension LICENSE..."
            npx wrangler@4.54.0 r2 object put "${R2_BASE}/${EXT_PATH}/LICENSE" \
              --file "${EXT_PATH}/LICENSE" \
              --content-type "text/plain; charset=utf-8" \
              --remote
          fi

          echo "=== Documentation deployed successfully! ==="
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
